name: Android

on: [push, pull_request, workflow_dispatch]

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]
        api: [21]
    env:
      NDK_CHANNEL: r27d
      ANDROID_ABI: ${{ matrix.abi }}
      ANDROID_API: ${{ matrix.api }}
      # Keep build output out of the repo tree
      NDK_OUT_DIR: ${{ github.workspace }}/out/${{ matrix.abi }}
      NDK_LIBS_DIR: ${{ github.workspace }}/libs/${{ matrix.abi }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: .ndk/android-ndk-${{ env.NDK_CHANNEL }}
          key: ndk-${{ env.NDK_CHANNEL }}

      - name: Download NDK (if cache miss)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          mkdir -p .ndk
          curl -L -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${NDK_CHANNEL}-linux.zip"
          unzip -q ndk.zip -d .ndk
          rm ndk.zip

      - name: Set NDK env + PATH
        run: |
          echo "NDK=${GITHUB_WORKSPACE}/.ndk/android-ndk-${NDK_CHANNEL}" >> $GITHUB_ENV
          echo "${GITHUB_WORKSPACE}/.ndk/android-ndk-${NDK_CHANNEL}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Build with ndk-build
        working-directory: android/jni
        run: |
          set -euxo pipefail
          mkdir -p "${NDK_OUT_DIR}" "${NDK_LIBS_DIR}"
          # Build one ABI per job. We also pin APP_PLATFORM to the matrix API.
          "${NDK}/ndk-build" -j \
            APP_ABI="${ANDROID_ABI}" \
            APP_PLATFORM="android-${ANDROID_API}" \
            NDK_OUT="${NDK_OUT_DIR}" \
            NDK_LIBS_OUT="${NDK_LIBS_DIR}"

      - name: Show outputs
        run: |
          set -euxo pipefail
          find "${NDK_LIBS_DIR}" -maxdepth 2 -type f -print0 | xargs -0 ls -lh || true
          file "${NDK_LIBS_DIR}/"* || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libusb-android-${{ matrix.abi }}-api${{ matrix.api }}
          path: |
            libs/${{ matrix.abi }}/
          if-no-files-found: error
